name: Update Subscription

on:
  workflow_dispatch: # Кнопка "Run" для ручного запуска
  schedule:
    - cron: '0 4 * * *' # Авто-запуск каждый день в 4 утра

jobs:
  convert-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download and Run Subconverter
        run: |
          # Скачиваем бинарник (Linux 64-bit)
          wget https://github.com/tindy2013/subconverter/releases/download/v0.9.0/subconverter_linux64.tar.gz
          tar -zxf subconverter_linux64.tar.gz
          
          # Запускаем в фоне (лог в файл для отладки)
          cd subconverter
          nohup ./subconverter > subconverter.log 2>&1 &
          
          # Ждем пару секунд пока стартанет
          sleep 5

      - name: Generate Config
        env:
          # Сюда кладете ваши ссылки через '|' в настройках репозитория (Settings -> Secrets)
          # Пример: https://link1.com|https://link2.com
          SUBS: ${{ secrets.MY_SUBS }}
        run: |
          # Берём первую ссылку из списка (не печатаем сам секрет)
          FIRST_URL="${SUBS%%|*}"
          mkdir -p subconverter

          # Скачиваем один пример исходника для диагностики
          curl -sS "$FIRST_URL" -o subconverter/source.txt || true
          echo "---- source head (first 40 lines) ----"
          head -n 40 subconverter/source.txt || true

          # Простая детекция формата: если есть vmess/vless/trojan — считаем V2Ray-подпиской
          if grep -qE 'vmess://|vless://|trojan://' subconverter/source.txt; then
            TARGET="v2ray"
          else
            TARGET="clash"
          fi
          echo "Selected target: $TARGET"

          # Кодируем URL(ы) для subconverter
          ENCODED_URLS=$(python3 -c "import urllib.parse, os; print(urllib.parse.quote(os.environ['SUBS']))")

          # Ждём пока subconverter поднимется (до ~15s)
          for i in {1..15}; do
            if curl -sS http://127.0.0.1:25500/ >/dev/null 2>&1; then break; fi
            sleep 1
          done

          # Запрос к локальному subconverter, результат сохраняем в папку `subconverter` чтобы совпадало с коммитом
          curl -sS -o subconverter/clash.yaml "http://127.0.0.1:25500/sub?target=$TARGET&url=$ENCODED_URLS&insert=false&config=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full.ini" || true

          # Диагностика на случай ошибки
          if [ ! -s subconverter/clash.yaml ]; then
            echo "Error: Empty config generated"
            echo "==== subconverter log (tail) ===="
            tail -n 200 subconverter/subconverter.log || true
            echo "==== source sample (head) ===="
            head -n 200 subconverter/source.txt || true
            exit 1
          fi

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update subscription config [skip ci]"
          file_pattern: 'subconverter/clash.yaml' # Какой файл коммитить
          push_options: '--force' # Опционально, если нужно перезаписывать

