name: Update Subscription

on:
  workflow_dispatch: # Кнопка "Run" для ручного запуска
  schedule:
    - cron: '0 4 * * *' # Авто-запуск каждый день в 4 утра

jobs:
  convert-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download and Run Subconverter
        run: |
          # Скачиваем бинарник (Linux 64-bit)
          wget https://github.com/tindy2013/subconverter/releases/download/v0.9.0/subconverter_linux64.tar.gz
          tar -zxf subconverter_linux64.tar.gz
          
          # Запускаем в фоне (лог в файл для отладки)
          cd subconverter
          nohup ./subconverter > subconverter.log 2>&1 &
          
          # Ждем пару секунд пока стартанет
          sleep 5

      - name: Generate Config
        env:
          # Сюда кладете ваши ссылки через '|' в настройках репозитория (Settings -> Secrets)
          # Пример: https://link1.com|https://link2.com
          SUBS: ${{ secrets.MY_SUBS }}
        run: |
          # Берём первую ссылку из списка (не печатаем сам секрет)
          FIRST_URL="${SUBS%%|*}"
          mkdir -p subconverter

          # Скачиваем один пример исходника для диагностики
          curl -sS "$FIRST_URL" -o subconverter/source.txt || true
          echo "---- source head (first 40 lines) ----"
          head -n 40 subconverter/source.txt || true

          # Детекция формата (сначало явно проверяем ss/ssr):
          # - если есть ss:// или ssr:// => считаем Shadowsocks -> clash
          # - иначе ищем vmess/vless/trojan или JSON-поля вида "key": -> v2ray
          if grep -qE 'ss://|ssr://' subconverter/source.txt; then
            TARGET="clash"
          elif grep -qE 'vmess://|vless://|trojan://' subconverter/source.txt || \
               grep -qE '"(add|ps|port|protocol)"\s*:' subconverter/source.txt; then
            TARGET="v2ray"
          else
            TARGET="clash"
          fi
          echo "Selected target: $TARGET"

          # Кодируем URL(ы) для subconverter
          ENCODED_URLS=$(python3 -c "import urllib.parse, os; print(urllib.parse.quote(os.environ['SUBS']))")

          # Ждём пока subconverter поднимется (до ~15s)
          for i in {1..15}; do
            if curl -sS http://127.0.0.1:25500/ >/dev/null 2>&1; then break; fi
            sleep 1
          done

          # Запрос к локальному subconverter, сохраняем и тело ответа для диагностики
          curl -sS -o subconverter/response.txt "http://127.0.0.1:25500/sub?target=$TARGET&url=$ENCODED_URLS&insert=false&config=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Full.ini" || true
          # Если subconverter вернул что-то осмысленное, переместим в итоговый файл
          if [ -s subconverter/response.txt ]; then
            mv subconverter/response.txt subconverter/clash.yaml
          fi

          # Покажем небольшую превью сгенерированного файла для отладки
          if [ -s subconverter/clash.yaml ]; then
            echo "==== generated config (head) ===="
            head -n 40 subconverter/clash.yaml || true
            # Если subconverter вернул сообщение об отсутствии нод, считаем это ошибкой
            if grep -q "No nodes were found" subconverter/clash.yaml; then
              echo "Subconverter reports no nodes; failing for debug output"
              echo "==== subconverter log (tail) ===="
              tail -n 200 subconverter/subconverter.log || true
              echo "==== source sample (head) ===="
              head -n 200 subconverter/source.txt || true
              exit 1
            fi
          fi

          # Диагностика на случай ошибки
          if [ ! -s subconverter/clash.yaml ]; then
            echo "Error: Empty config generated"
            echo "==== subconverter log (tail) ===="
            tail -n 200 subconverter/subconverter.log || true
            echo "==== source sample (head) ===="
            head -n 200 subconverter/source.txt || true
            echo "==== subconverter response (head) ===="
            head -n 200 subconverter/response.txt || true
            exit 1
          fi

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update subscription config [skip ci]"
          file_pattern: 'subconverter/clash.yaml' # Какой файл коммитить
          push_options: '--force' # Опционально, если нужно перезаписывать

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: subconverter-debug
          path: |
            subconverter/source.txt
            subconverter/response.txt
            subconverter/subconverter.log
            subconverter/clash.yaml

